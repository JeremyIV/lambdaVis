<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lambda Calculus Visualizer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="common.js"></script>
    <script src="macros.js"></script>
    <script src="parseChurchLambdaString.js"></script>
    <script src="churchLambdaToString.js"></script>
    <script src="lambdaCalculus.js"></script>
    <script src="expressions.js"></script>
    <script src="lambdaRenderer.js"></script>
    <link rel="stylesheet" href="lambda.css">
</head>
<body>
    <main>
        <div class="controls">
            <h1>Lambda Calculus Visualizer</h1>
            <div class="controls-row">
                <div class="input-group">
                    <textarea id="lambdaString" rows="1" placeholder="Enter lambda expression, e.g. (:x y.x)(:x y.y)" spellcheck="false"></textarea>
                    <button type="button" id="expand-btn" class="expand-btn" title="Expand to multi-line editor">&#x25BC;</button>
                </div>
                <div class="button-group">
                    <button type="button" id="load-btn" onclick="parseAndLoad()">Load</button>
                    <button type="button" id="reduce-btn" onclick="update()">Reduce <kbd>Space</kbd></button>
                    <button type="button" id="play-btn" onclick="togglePlay()">Play</button>
                    <div class="speed-controls">
                        <button type="button" id="speed-down-btn" onclick="speedDown()" title="Slow down" disabled>&minus;</button>
                        <span id="speed-display">1x</span>
                        <button type="button" id="speed-up-btn" onclick="speedUp()" title="Speed up">+</button>
                    </div>
                    <button type="button" id="back-btn" onclick="goBack()">Back</button>
                </div>
            </div>
            <div class="expression-bar">
                <code id="current-expr">-</code>
                <span id="step-counter" class="step-counter"></span>
            </div>
        </div>

        <div class="content">
            <div id="tree-container">
                <!-- SVG will be inserted here -->
            </div>

            <aside class="sidebar" id="sidebar">
                <button type="button" id="sidebar-toggle" class="sidebar-toggle" title="Toggle sidebar">&#x25B6;</button>

                <div class="sidebar-content">
                    <section class="examples">
                        <h3>Examples</h3>
                        <div class="example-list" id="example-list">
                            <!-- Examples will be populated by JavaScript -->
                        </div>
                    </section>

                    <section class="syntax-help">
                        <h3>Syntax</h3>
                        <dl>
                            <dt><code>:x.body</code></dt>
                            <dd>Lambda (λx.body)</dd>
                            <dt><code>:x y.body</code></dt>
                            <dd>Multi-param lambda</dd>
                            <dt><code>f x</code></dt>
                            <dd>Application (f applied to x)</dd>
                            <dt><code>(expr)</code></dt>
                            <dd>Grouping</dd>
                        </dl>
                    </section>

                    <section class="legend">
                        <h3>Legend</h3>
                        <div class="legend-items">
                            <div class="legend-item">
                                <span class="legend-circle lambda"></span>
                                <span>Lambda (λ)</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-circle variable"></span>
                                <span>Variable</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-circle application"></span>
                                <span>Application</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-line"></span>
                                <span>Tree edge</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-curve"></span>
                                <span>Variable binding</span>
                            </div>
                        </div>
                    </section>
                </div>
            </aside>
        </div>
    </main>
    
    <script>
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initialize);

        const lambdaInput = document.getElementById('lambdaString');
        const expandBtn = document.getElementById('expand-btn');
        let expanded = false;

        // Handle keyboard in textarea
        lambdaInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                if (!expanded) {
                    // Single-line mode: Enter submits
                    e.preventDefault();
                    parseAndLoad();
                } else if (e.ctrlKey || e.metaKey) {
                    // Multi-line mode: Ctrl/Cmd+Enter submits
                    e.preventDefault();
                    parseAndLoad();
                }
            }
        });

        // Space key triggers beta reduction (when not focused on input)
        document.addEventListener('keydown', function(e) {
            if (e.key === ' ' && e.target !== lambdaInput) {
                e.preventDefault();
                const reduceBtn = document.getElementById('reduce-btn');
                if (reduceBtn && !reduceBtn.disabled) {
                    update();
                }
            }
        });

        // Toggle expand/collapse
        expandBtn.addEventListener('click', function() {
            expanded = !expanded;
            document.body.classList.toggle('editor-expanded', expanded);
            lambdaInput.classList.toggle('expanded', expanded);
            expandBtn.classList.toggle('expanded', expanded);
            expandBtn.innerHTML = expanded ? '&#x25B2;' : '&#x25BC;';
            expandBtn.title = expanded ? 'Collapse to single line' : 'Expand to multi-line editor';
            if (expanded) {
                lambdaInput.style.resize = 'vertical';
            } else {
                lambdaInput.style.resize = 'none';
                lambdaInput.style.height = '';
            }
            lambdaInput.focus();
        });

        // Sidebar toggle
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('sidebar');
        const isMobile = () => window.innerWidth <= 768 || (matchMedia('(pointer: coarse) and (hover: none)').matches);

        function sidebarArrow(collapsed) {
            if (isMobile()) {
                return collapsed
                    ? 'Examples &amp; Reference &#x25B2;'
                    : '&#x25BC;'; // ▼
            }
            return collapsed ? '&#x25C0;' : '&#x25B6;'; // ◀ / ▶
        }

        // Auto-collapse sidebar on mobile at page load
        if (isMobile()) {
            sidebar.classList.add('collapsed');
            sidebarToggle.innerHTML = sidebarArrow(true);
            // Open the first section (Examples) by default
            const firstSection = sidebar.querySelector('section');
            if (firstSection) firstSection.classList.add('open');
        }

        sidebarToggle.addEventListener('click', function() {
            sidebar.classList.toggle('collapsed');
            sidebarToggle.innerHTML = sidebarArrow(sidebar.classList.contains('collapsed'));
            // Trigger resize so tree recalculates dimensions
            setTimeout(() => handleResize(), 300);
        });

        // Mobile accordion toggles for sidebar sections
        sidebar.addEventListener('click', function(e) {
            if (!isMobile()) return;
            const h3 = e.target.closest('h3');
            if (!h3) return;
            const section = h3.parentElement;
            if (section && section.tagName === 'SECTION') {
                section.classList.toggle('open');
            }
        });
    </script>
</body>
</html>
